const dgram = require('dgram');
const server = dgram.createSocket('udp4');
let end_data = false
let refresh = 200

function handler_message(msg, rinfo){
    const headers = msg.readUInt16BE(0)
    let session = Buffer.from('9981', 'hex')
    let session_ping = null
    switch(headers){
        case 0x8006:
            const buff7f_before = Buffer.concat([Buffer.from('3f020000', 'hex'), session])
            if(msg.readUInt8(5)+1 > 255){
                buff7f_before.writeUint8(0, 5)
            }else{
                buff7f_before.writeUint8(msg.readUInt8(5)+1, 2)
            }

            buff7f_before.writeUint8(msg.readUInt8(4), 3)

            return [buff7f_before]
        break;

        case 0x3f00:
            return client_action(msg)
        break;
        case 0x0003: //<- party data
            return [Buffer.from('3f00030400fe426f743030005063003477000310e87c02ff10649104e55e1d465c55b244ba37d045b20435bf00000000340535bf000155000000803f02000000', 'hex')]
        break;
        case 0x7f01:
            return [Buffer.from('3f00020410ff004db3e48dc56d5f06442e47eac4c3f5c8bfff00000058656e646f3232323234770000004c0000409c4664006400', 'hex')]
        break;
        case 0x3f02:
            session_ping = msg.slice(3, -1)
            let res =  Buffer.from('800601000b0a000035507300','hex')
            let tick = Buffer.from("3f000a0802d8", "hex")
            if(msg.readUInt8(2)+1 > 255){
                res.writeUint8(0, 5)
                tick.writeUint8(0, 3)
                
            }else{
                res.writeUint8(msg.readUInt8(2)+1, 5)
                tick.writeUint8(msg.readUInt8(2)+1, 3)
            }
            res.writeUint8(msg.readUInt8(3), 4)
            tick.writeUint8(msg.readUInt8(3), 2)
            res = [res]
            if(!end_data){
                res = [msg]
            }else if(refresh <= 0){
                res.push(tick)
                refresh = 200
            }
            refresh = refresh - 1 
            return [...res]
        break;
        case 0x7f00:
            if(msg.readUInt8(2) === 0x01){
                const buff7f_before = Buffer.from('7f000102c2000000000000000000000050000000010000000000000002000000e00000001800000000000000000000000000000000000000000000000000000018b0adb7a5cc8c4993d20c33eeb0ead51242191fb8bb154e44017636310079321bb09db7030000000000000002000000000000001ab08db700000000020400000200000000000000070000000000000000000000000000000000000000000000000000001bb09db70000000000020000030000000000000007000000cc0000001400000000000000000000000000000000000000430068006100760061006c006f007400650000005b004500530050005d000300580065006e0064006f000000', 'hex')
                const buff7f_after = Buffer.from('c3a737e005000000000000000200000000000000c2a747e00000000002040000020000000000000007000000000000000000000000000000000000000000000000000000c3a737e00000000000020000050000000000000007000000cc0000001400000000000000000000000000000000000000430068006100760061006c006f007400650000005b004500530050005d000300580065006e0064006f000000', 'hex')
                
                const buff7f = Buffer.concat([buff7f_before, session, buff7f_after])
                
                return [buff7f_before]
            }else{ 
                console.log('0x07 no recognice')
                const buff = Buffer.from('3f00030400fe4a756e696f7250633200681c6f7558920bff02641900374814c544220242674885c531efc33e0000000059836c3f000066000000803f02000000', 'hex')
                if(msg.readUInt8(3)+1 > 255){
                    buff.writeUint8(0, 2)
                }else{
                    buff.writeUint8(msg.readUInt8(3)+1, 2)
                }
                buff.writeUInt8(msg.readUInt8(2), 3)
                const buff2 = Buffer.from('3700020400ff004d374814c544220242674885c5f90fc93eff0000004a756e696f725063320068000000000000409c4690016400', 'hex')
                if(msg.readUInt8(3)+2 > 255){
                    buff2.writeUint8(0, 2)
                }else{
                    buff2.writeUint8(msg.readUInt8(3)+2, 2)
                }
                buff2.writeUInt8(msg.readUInt8(2), 3)
                const buff3 = Buffer.from('3f00050500d2445f4153414c544f0049414c000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2445f4d41445249440049414c000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f5645525449474f004c000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f474152414a4500004c000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f4d4f4f4e4c49474854000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f4d4554524f00474854000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f4c4f5645424f415400000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b00702600', 'hex')
                const buff4 = Buffer.from('3f00060600d2444d5f494e445553545249414c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f5255494e41530049414c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d5f4d415242454c4c41004c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d24d505f444f5f4d5553454f004c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f5645525449474f004c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f474152414a4500004c0000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f4d4f4f4e4c494748540000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b00702600', 'hex')
                const buff5 = Buffer.from('3f00070600d2444d545f4d4554524f004748540000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f4c4f5645424f4154000000306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f494e445553545249414c00306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f5255494e41530049414c00306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b0070260000d2444d545f4d415242454c4c41004c00306a003202000068d4190092f78277d8820e0000005c002e19000000005c00b0d41900a3f2827700005c0080a06b00702600fefbff044a756e696f725063320520736520686120636f6e65637461646f000200000000ec0900e500000000630000630000000000000000383838383232382e61de', 'hex')
                return [buff2, buff, buff3, buff4, buff5]
            }
           
            break;
        case 0x8002:
            
            session_ping = msg.slice(8, 11)
            return [Buffer.concat([Buffer.from('3f020000', 'hex'), session])]
            break;
        case 0x8801:
            session = msg.slice(8, 11)


            msg.writeUInt8(0x02, 1)
            return [msg]
        break;
        case 0x0002:
            //hello client msg
            const buffer00002 = Buffer.from('000301c170000000ec01000050000000010000000000000001000000580000001800000000000000000000000000000000000000000000000000000018b0adb7a5cc8c4993d20c33eeb0ead51242191fb8bb154e44017636310079325b004500530050005d000300580065006e0064006f0000000020537258656e646f0000000000000000003139322e3136382e312e3133340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005b4553505d0358656e646f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004d505f444d5f5645525449474f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000444d5f5645525449474f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e0000000100000806fa00b8220000e703','hex')
            buffer00002.writeUInt8(msg.readUInt8(2) ,2)
            buffer00002.writeUInt8(msg.readUInt8(3) ,3)
            //session = msg.slice(4, msg.length )
            return [buffer00002]
            break;
        default: 
            console.log("err: msg not recognice: ",msg.toString('hex'))
            console.error(new Error('msg not recognice'))
            return []
        break;
    }
}
function client_action(msg){
    let res = []
    if(!end_data){

        const sec = Buffer.from('3700020400ff004dc133c3c51e0f4044d17f5fc6f90f49400100000058656e646f3232323200540000004b0000409c4664006400','hex')
        end_data = true
        return [sec, Buffer.from('3f00030400fe58656e646f323232320054004404505b030102646d04c133c3c51e0f4044d17f5fc6f5eef2b600000000000080bf000054000000803f02000000', 'hex')]
    }else{
        switch(msg.readUInt8(5)){
            case 0x0e:
                return [] 
            break;
        }

    }
    return []
}
server.on('message', (msg, rinfo) => {
    console.log(`Mensaje recibido: ${rinfo.address}:${rinfo.port}\n${msg.toString('hex')}`);
    console.log('handler_message')
    const responses = handler_message(msg, rinfo)
    if(responses){
        for(let response of responses){

            server.send(response, rinfo.port, rinfo.address, (err) => {
            if (err) {
                console.error(`Error al enviar la respuesta: ${err.message}`);
            } else {
                console.log(`Respuesta enviada: ${rinfo.port}:${rinfo.address} : `, response.toString('hex'));
                
            }
            
            console.log(`------FIN DEL MENSAJE------`);

            });
        }
    }

});
server.on('listening', () => {
  const address = server.address();
  console.log(`Servidor UDP escuchando en ${address.address}:${address.port}`);
  console.log(`------INICIO DE LA ESCUCHA------`);
});

server.on('error', (err) => {
  console.error(`Error en el servidor: ${err.message}`);
  server.close();
});


// Configuraci√≥n del servidor

const HOST = '0.0.0.0';
server.bind(8888, HOST);